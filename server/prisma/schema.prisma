// 论文跟踪系统 Prisma Schema 定义
// 更新日期: 2024

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // 支持 mysql, sqlite 等
  url      = env("DATABASE_URL")
}

// 用户模型
model User {
  // 主键和基础认证信息
  id            Int      @id @default(autoincrement())
  username      String   @unique @db.VarChar(50)
  email         String   @unique @db.VarChar(255)
  passwordHash  String   @db.VarChar(255)
  
  // 用户信息
  firstName     String?  @db.VarChar(100)
  lastName      String?  @db.VarChar(100)
  avatar        String?  @db.VarChar(500)
  bio           String?  @db.Text
  
  // 角色和状态
  role          UserRole @default(USER)
  isActive      Boolean  @default(true)
  
  // 时间戳
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime?
  
  // 关系定义
  papers        Paper[]  // 用户拥有多个论文
  
  @@map("users")
  @@index([username])
  @@index([email])
  @@index([role])
  @@index([isActive])
}

// 论文模型
model Paper {
  // 主键和基本信息
  id          Int      @id @default(autoincrement())
  title       String   @db.VarChar(200)
  description String?  @db.Text
  
  // 截止日期和时间管理
  deadline    DateTime
  startDate   DateTime @default(now())
  
  // 论文状态和进度
  status      PaperStatus @default(ACTIVE)
  priority    Priority   @default(MEDIUM)
  
  // 字数统计
  totalWords  Int       @default(0)
  targetWords Int?
  
  // 外键关系
  userId      Int
  
  // 时间戳
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?
  
  // 关系定义
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  progresses  Progress[] // 论文拥有多个进度记录
  
  @@map("papers")
  @@index([userId])
  @@index([deadline])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
}

// 进度模型
model Progress {
  // 主键
  id       Int @id @default(autoincrement())
  
  // 外键关系
  paperId  Int
  
  // 进度信息
  progressPercentage Int    @db.SmallInt  // 0-100的进度百分比
  completedWords     Int?   // 已完成的字数
  dailyTarget        Int?   // 每日目标字数
  
  // 进度详情
  note         String? @db.Text          // 进度备注
  phase        PaperPhase?               // 写作阶段
  milestones   String? @db.Text          // 里程碑描述
  
  // 时间记录
  date         DateTime @default(now())  // 进度记录日期
  timeSpent    Int?     @default(0)      // 花费时间（分钟）
  
  // 时间戳
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // 关系定义
  paper        Paper    @relation(fields: [paperId], references: [id], onDelete: Cascade)
  
  @@map("progresses")
  @@index([paperId])
  @@index([date])
  @@index([progressPercentage])
  @@index([phase])
}

// 枚举类型定义

// 用户角色
enum UserRole {
  USER      @map("USER")
  ADMIN     @map("ADMIN")
  SUPERADMIN @map("SUPERADMIN")
}

// 论文状态
enum PaperStatus {
  ACTIVE    @map("ACTIVE")     // 进行中
  COMPLETED @map("COMPLETED")  // 已完成
  PAUSED    @map("PAUSED")     // 暂停
  CANCELLED @map("CANCELLED")  // 取消
  DRAFT     @map("DRAFT")      // 草稿
}

// 论文优先级
enum Priority {
  LOW      @map("LOW")
  MEDIUM   @map("MEDIUM")
  HIGH     @map("HIGH")
  URGENT   @map("URGENT")
}

// 写作阶段
enum PaperPhase {
  PLANNING      @map("PLANNING")      // 规划阶段
  RESEARCH      @map("RESEARCH")      // 研究阶段
  OUTLINE       @map("OUTLINE")       // 大纲阶段
  WRITING       @map("WRITING")       // 写作阶段
  REVISING      @map("REVISING")      // 修改阶段
  FINAL_REVIEW  @map("FINAL_REVIEW")  // 最终审核
  SUBMITTED     @map("SUBMITTED")     // 已提交
  PUBLISHED     @map("PUBLISHED")     // 已发表
}